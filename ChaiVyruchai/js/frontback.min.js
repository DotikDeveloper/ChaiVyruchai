document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("userPhoto"),t=document.getElementById("orgLogo"),a=document.getElementById("settings"),s=document.getElementById("org_add_with_user"),o=document.getElementById("check_code"),n=document.querySelector(".moderation-requests__list"),r=document.getElementById("phone_confirm"),i=document.querySelector("button[data-button=close-modal]"),l=document.querySelector(".messages__list"),c=document.querySelector(".many-output__number"),d=document.querySelector(".reviews__list"),m=document.getElementById("chart-waiter"),g=document.getElementById("filter_rating"),u=document.getElementById("filter_stat"),_=document.getElementById("form_message"),p=document.getElementById("form_chai"),v=document.getElementById("pay_out"),y=document.getElementById("card_enroll");function h(e){return new Date(new Date(Date.now()+24*-e*3600*1e3).toUTCString().toString().split("GMT")[0]+" UTC").toISOString().split(".")[0].replace(/-/g,".")}Date.prototype.daysInMonth=function(){return 33-new Date(this.getFullYear(),this.getMonth(),33).getDate()};const f=(e=30)=>{let t=new FormData;t.append("get_statement",""),t.append("get_statement_start",h(e)),t.append("get_statement_end",new Date((new Date).toUTCString().toString().split("GMT")[0]+" UTC").toISOString().split(".")[0].replace(/-/g,".")),(async()=>{let a=await fetch("/pay",{method:"POST",body:t}),s=await a.json(),o=[];console.log("%c answer xml%o","background: #333; font-size: x-large; color: #f00",typeof s.StatementRow),Array.isArray(s.StatementRow)&&s.StatementRow.map(e=>{o.push({date:e.date.slice(0,10).replace(/-/g,"."),amount:e.amount/100})}),o="object"!=typeof s.StatementRow||Array.isArray(s.StatementRow)?o:{[s.StatementRow.date.slice(0,10).replace(/-/g,".")]:s.StatementRow.amount/100},o=o.length>1?o.reduce((e,t)=>{const{date:a,amount:s}=t;return e[a]||(e[a]=0),e[a]+=s,e},{}):o;let n=[];for(let t=0;t<e;t++)n[h(t).slice(0,10)]=o[h(t).slice(0,10)]?o[h(t).slice(0,10)]:0;console.log("%c answer xml%o","background: #333; font-size: x-large; color: #f00",s.StatementRow,o,n),function(e){labels=[],data=[];for(const t in e)labels.push(t.slice(5,10)),data.push(e[t]);console.log("WWWWWWWWWWW",labels,data);var t=document.getElementById("totalStats2").getContext("2d");new Chart(t,{type:"line",data:{labels:labels,datasets:[{label:"Сборы за месяц",backgroundColor:"rgba(111, 149, 145, 0.25)",borderColor:" #ca583e",data:data}]},options:{}})}(n)})()};if(v&&(v.onsubmit=async e=>{e.preventDefault();let t=await fetch("/pay",{method:"POST",body:new FormData(v)}),a=await t.json();console.clear,console.log("%cLINK%s",a,"color: pink"),document.location.href=a}),y&&(y.onclick=async e=>{e.preventDefault();let t=new FormData;t.append("card_enroll","");let a=await fetch("/pay",{method:"POST",body:t}),s=await a.json();document.location.href=s}),c){let e=new FormData;e.append("get_balance",""),(async()=>{let t=await fetch("/pay",{method:"POST",body:e}),a=await t.json();c.innerHTML=a})()}if(m&&f(),d){let e=new FormData;e.append("get_reviews",""),(async()=>{let t=await fetch("/pay",{method:"POST",body:e}),a=await t.json(),s="";a.map(e=>{s+='<li class="messages__item reviews__item">',s+=`<div class="reviews__volume">${e.rating}</div>`,s+=`<div class="reviews__cash"><span class="reviews__cash--number">${e.amount}</span> руб.</div>`,s+='<div class="messages__text">',s+=""+e.comment,s+='<span class="messages__date"> ',s+=""+e.date,s+="</span>",s+="</div>",s+="</li>"}),d.innerHTML=s})()}function b(){let e=new FormData;e.append("load_messages",""),fetch("/",{method:"POST",body:e}).then((function(e){return e.json()})).then((function(e){e.forEach(e=>{console.log(e),""==e.ava&&(e.ava="img/admin/ava__adm1.jpeg"),l.insertAdjacentHTML("beforeend",'<li class="messages__item" message_id="'+e.message_id+'"><div class="messages__user"><div class="messages__user--avatar"><img class="messages__user--avatar-img" src="'+e.ava+'" alt="ava"></div><div class="messages__user--first_name">'+e.first_name+'</div><div class="messages__user--last_name">'+e.last_name+'</div><div class="messages__user--org_name">'+e.organization+'</div><div class="messages__user--role">Официант</div></div><div class="messages__text">'+e.message+' <span class="messages__date">'+e.date+'</span></div><div class="messages__status">\x3c!-- <button class="messages__btn btn-no">в работе</button> --\x3e<button class="messages__btn btn-yes" data-req="yes">выполнено</button></div></li>')})}))}g&&g.addEventListener("click",e=>{if("1"===e.target.getAttribute("target")||"2"===e.target.getAttribute("target")||"3"===e.target.getAttribute("target")){let t=new FormData;t.append("get_reviews",e.target.getAttribute("target")),(async()=>{let e=await fetch("/pay",{method:"POST",body:t}),a=await e.json(),s="";a.map(e=>{s+='<li class="messages__item reviews__item">',s+=`<div class="reviews__volume">${e.rating}</div>`,s+=`<div class="reviews__cash"><span class="reviews__cash--number">${e.amount}</span> руб.</div>`,s+='<div class="messages__text">',s+=""+e.comment,s+='<span class="messages__date"> ',s+=" "+e.date,s+="</span>",s+="</div>",s+="</li>"}),d.innerHTML=s,g.classList.add("hide")})()}}),u&&u.addEventListener("click",e=>{switch(e.target.getAttribute("target")){case"1":f(1),u.classList.add("hide");break;case"2":f(7),u.classList.add("hide");break;default:f(),u.classList.add("hide")}}),p&&(p.onsubmit=async e=>{e.preventDefault();let t=await fetch("/pay",{method:"POST",body:new FormData(p)}),a=await t.json();console.log(a),document.location.href=a}),n&&function(){let e=new FormData;e.append("load_moderations",""),fetch("/users",{method:"POST",body:e}).then((function(e){return e.json()})).then((function(e){e.forEach(e=>{console.log(e),""==e.ava&&(e.ava="img/admin/ava__adm1.jpeg"),n.insertAdjacentHTML("beforeend",'<li class="moderation-requests__item" user_id="'+e.user_id+'"><div class="moderation-requests__item--avatar"><img class="moderation-requests__item--avatar-img" src="'+e.ava+'" alt="ava"></div><div class="moderation-requests__item-block-name"><div class="moderation-requests__item--first_name">'+e.first_name+'</div><div class="moderation-requests__item--last_name">'+e.last_name+'</div><div class="moderation-requests__item--org_name">'+e.organization+'</div></div><div class="moderation-requests__item--role">Официант</div><div class="moderation-requests__item-block-btn"><button class="moderation-requests__item--yes" data-req="yes">да</button><button class="moderation-requests__item--no" data-req="no">нет</button></div></li>')})}))}(),l&&b(),a&&(a.onsubmit=async e=>{e.preventDefault();let t=await fetch("/",{method:"POST",body:new FormData(a)}),s=await t.json();if(a.reset(),"ok"==s.answer){let e=new FormData;e.append("get_data_user",""),fetch("/",{method:"POST",body:e}).then((function(e){return e.json()})).then((function(e){console.log(e.first_name),document.querySelector(".login__info--user-name").textContent=e.first_name}))}}),o&&(o.onsubmit=async e=>{e.preventDefault();let t=await fetch("/users",{method:"POST",body:new FormData(o)}),a=await t.json();console.log(a),o.reset(),0==a.answer&&(document.querySelector(".modal__description--danger").style="opacity: 1",setTimeout(()=>document.querySelector(".modal__description--danger").style="opacity: 0",3e3)),"ok"==a.answer&&document.querySelector(".overlay").classList.add("hide")}),_&&(_.onsubmit=async e=>{e.preventDefault();let t=await fetch("/",{method:"POST",body:new FormData(_)});await t.json();_.reset(),l.innerHTML="",b()}),s&&(s.onsubmit=async e=>{e.preventDefault();let t=await fetch("/organizations",{method:"POST",body:new FormData(s)});console.log(t);let a=await t.json();console.log(a),"ok"==a.answer&&s.reset()}),e&&e.addEventListener("change",()=>{w(e.files[0]),console.log("Аватар загружен")}),t&&t.addEventListener("change",()=>{S(t.files[0]),console.log("Логотип загружен")}),n&&n.addEventListener("click",e=>{if(e.target.classList.contains("moderation-requests__item--yes"),"yes"==e.target.getAttribute("data-req")){e.target.closest("li").style.backgroundColor="rgba(111, 149, 145, 0.25)",e.target.closest("li").style.border="5px solid rgba(111, 149, 145, 0.25)",e.target.closest("li").style.padding="0";let t=new FormData;t.append("moderate_ok",e.target.closest("li").getAttribute("user_id")),fetch("/users",{method:"POST",body:t}).then((function(e){return e.json()})).then((function(e){console.log(e)})),setTimeout(()=>e.target.closest("li").remove(),1e3)}if("no"==e.target.getAttribute("data-req")){e.target.closest("li").style.backgroundColor="rgba(202, 88, 62, 0.25)",e.target.closest("li").style.border="5px solid rgba(202, 88, 62, 0.25)",e.target.closest("li").style.padding="0";let t=new FormData;t.append("moderate_failure",e.target.closest("li").getAttribute("user_id")),fetch("/users",{method:"POST",body:t}).then((function(e){return e.json()})).then((function(e){console.log(e)})),setTimeout(()=>e.target.closest("li").remove(),1e3)}}),l&&l.addEventListener("click",e=>{if(e.target.classList.contains("btn-yes"),"yes"==e.target.getAttribute("data-req")){e.target.closest("li").style.backgroundColor="rgba(111, 149, 145, 0.25)",e.target.closest("li").style.border="5px solid rgba(111, 149, 145, 0.25)",e.target.closest("li").style.padding="0";let t=new FormData;t.append("message_ok",e.target.closest("li").getAttribute("message_id")),fetch("/",{method:"POST",body:t}).then((function(e){return e.json()})).then((function(e){console.log(e)})),setTimeout(()=>e.target.closest("li").remove(),1e3)}});const w=t=>{if(console.log(t.name),!["image/jpeg","image/png","image/gif","image/svg+xml"].includes(t.type))return void alert("Допустимы изображения png, gif, jpeg, svg");if(t.size>10485760)return void alert("Размер файла не должен превышать 10 мб");const a=new FormData;a.append("file_attach",e.files[0]),D("/",a).then(e=>{console.log("успешная отправка");let t=new FormData;t.append("get_data_user",""),fetch("/",{method:"POST",body:t}).then((function(e){return e.json()})).then((function(e){console.log(e.ava),document.querySelector(".login__avatar--img").removeAttribute("src"),document.querySelector(".login__avatar--img").setAttribute("src",e.ava+"?"+Math.random())}))}).catch(()=>console.log("отправка не удалась"))},S=e=>{if(console.log(e.name),!["image/jpeg","image/png","image/gif","image/svg+xml"].includes(e.type))return void alert("Допустимы изображения png, gif, jpeg, svg");if(e.size>2097152)return void alert("Размер файла не должен превышать 2 мб");const a=new FormData;a.append("logo_attach",t.files[0]),D("/",a).then(e=>{console.log("успешная отправка");let t=new FormData;t.append("get_data_org",""),fetch("/",{method:"POST",body:t}).then((function(e){return e.json()})).then((function(e){console.log(e.logo),document.querySelector(".login__logo--img").removeAttribute("src"),document.querySelector(".login__logo--img").setAttribute("src",e.logo+"?"+Math.random())}))}).catch(()=>console.log("отправка не удалась"))},D=async(e,t)=>{console.log("в процессе");let a=await fetch(e,{method:"POST",body:t});return await a.text()};r&&r.addEventListener("click",async e=>{document.querySelector(".overlay").classList.remove("hide");let t=new FormData;t.append("check_phone","");let a=await fetch("/users",{method:"POST",body:t});await a.json()}),i&&i.addEventListener("click",()=>{const e=document.querySelector(".overlay"),t=document.querySelectorAll("input");e.classList.add("hide"),t.forEach(e=>{e.value=""})})});